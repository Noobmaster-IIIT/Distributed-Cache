syntax = "proto3";

option go_package = "distributed-cache-go/gen/protos";

package metadata_cache;

service MetadataService {
  rpc NotifyPromotion (NotifyPromotionRequest) returns (NotifyPromotionResponse);
}

service CacheService {
  rpc GetResult (CacheRequest) returns (CacheResponse) {}
  rpc SetResult (CacheSetRequest) returns (CacheSetResponse) {}
  rpc GetLoad (EmptyRequest) returns (LoadResponse) {}
  rpc GetRole (EmptyRequest) returns (RoleResponse) {}
  rpc PromoteToPrimary (EmptyRequest) returns (PromotionResponse) {}
  rpc RegisterReplica (ReplicaRegisterRequest) returns (ReplicaRegisterResponse) {}
  rpc GetSnapshot (EmptyRequest) returns (SnapshotResponse) {}
  rpc SetSnapshot (SnapshotRequest) returns (SnapshotResponse) {}
  rpc GetOffset (EmptyRequest) returns (OffsetResponse) {}
  rpc PingWithOffset (PingRequest) returns (PingResponse) {}
  rpc InvalidateEntityCache (InvalidateEntityRequest) returns (InvalidateEntityResponse) {}
}

message QueryRequest {
  string query = 1;
}

message QueryResponse {
  string reply = 1;
}

message CacheRequest {
  string query_hash = 1;
}

message CacheResponse {
  string result = 1;
  bool found = 2;
}

message CacheSetResponse {
  bool success = 1;
}

message EmptyRequest {}

message LoadResponse {
  int32 load = 1;
}

message RegisterRequest {
  int32 server_id = 1;
  int32 port = 2;
  int32 cluster_id = 3;
}

message RegisterResponse {
  bool success = 1;
}

message RoleResponse {
  bool is_primary = 1;
}

message PromotionResponse {
  bool success = 1;
}

message ReplicaRegisterRequest {
  int32 replica_id = 1;
  int32 replica_port = 2;
}

message ReplicaRegisterResponse {
  bool success = 1;
}

message NotifyPromotionRequest {
  int32 server_id = 1;
  int32 port = 2;
  int32 cluster_id = 3;
}

message NotifyPromotionResponse {
  bool success = 1;
}

message PingRequest {
  int32 offset = 1;
  int32 server_id = 2;
}

message PingResponse {
  bool up_to_date = 1;
  repeated CacheSetRequest commands = 2; // <-- THIS IS THE CRITICAL ADDITION
}

message SnapshotRequest {
  bytes data = 1;
}

message SnapshotResponse {
  bool success = 1;
  bytes data = 2;
}

message CacheSetRequest {
  string query_hash = 1;
  string result = 2;
  string entity = 3;
  string operation = 4;
}

message OffsetResponse {
  int32 offset = 1;
}

message InvalidateEntityRequest {
  string entity = 1;
}

message InvalidateEntityResponse {
  bool success = 1;
}